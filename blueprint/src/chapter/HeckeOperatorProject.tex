\chapter{Miniproject: Hecke Operators}\label{HeckeOperator_project}

\section{Status}

This is an active miniproject. The abstract theory is completely formalized;
at the time of writing the concrete theory has no sorried definitions
but it does have some sorried proofs.

\section{The goal}

The goal of this project is to get sorry-free definitions of Hecke operators
acting on spaces of automorphic forms. These Hecke operators generate
Hecke algebras, which are the rings called $T$ in the modularity lifting theorems,
or $R=T$ theorems, crucially introduced by Wiles in order to prove FLT.

The theory comes in two parts;
the ``abstract'' theory, which is pure algebra, and the ``concrete'' theory
where we apply the abstract constructions to produce endomorphisms of
spaces of automorphic forms. The abstract theory is short (and completely formalized);
the concrete theory still needs some work because to apply the theory to the
adelic groups we care about we need to develop some more API around the theory
of restricted products, and of compact open subgroups of matrix groups.

\section{The abstract theory}

\subsection{Introduction}

The set-up: we have a commutative ring $R$, the coefficient ring, and
all of our spaces which the operators act on will be $R$-modules.

We have a group $G$ acting $R$-linearly on an $R$-module $A$.

We have subgroups $U$ and $V$ of $G$
We will be particularly interested in the $R$-modules $A^U$ and $A^V$
of invariant elements.

Given an element $g\in G$, then under a certain finiteness hypothesis
we will be able to define an $R$-linear map $T_g$ or $[UgV]$
from $A^V$ to $A^U$. The finiteness hypothesis is that the
double coset $UgV$ can be written as a finite union of single
cosets $g_iV$.

\begin{definition}
  \lean{AbstractHeckeOperator.HeckeOperator_toFun}
  \label{AbstractHeckeOperator.HeckeOperator_toFun}
  \leanok
  Assuming $UgV$ is a finite union of cosets $g_iV$,
  we define $[UgV]:A^V\to A^U$ to be the map sending $a\in A^V$
  to $\sum_i g_ia.$
\end{definition}

\begin{lemma}
  \lean{AbstractHeckeOperator.HeckeOperator}
  \label{AbstractHeckeOperator.HeckeOperator}
  \uses{AbstractHeckeOperator.HeckeOperator_toFun}
  \leanok
  This function is well-defined (that is, independent of the
  choice of $g_i$), has image in $A^U$ and is $R$-linear.
\end{lemma}
\begin{proof}
  \leanok
  Well-definedness is because if we change $g_i$ to $g'_i:=g_iv$
  for some $v\in V$ then $g_ia=g_i'a$ because $a\in A^V$.

  The image lands in $A^U$ because left multiplication by $u$
  fixes $UgV$ and hence permutes the cosets $g_iV$.

  Finally $R$-linearity is because the $G$-action is $R$-linear.
\end{proof}

The group $G$ is not in general commutative, and hence if $U=V$
the Hecke operators in this generality do not in general commute
as endomorphisms of $A^U$. Here is a criterion for
them to commute.

\begin{lemma}
  \lean{AbstractHeckeOperator.comm}
  \label{AbstractHeckeOperator.comm}
  \uses{AbstractHeckeOperator.HeckeOperator}
  \leanok
  Say $g,h\in G$ and we have $UgU=\coprod_i g_iU$
  and $UhU=\coprod_j h_j$ and we have $g_ih_j=h_jg_i$ for all $i,j$.
  Then $[UgU][UhU]=[UhU][UgU]$, that is, the Hecke operators
  acting on $A^U$ commute.
\end{lemma}
\begin{proof}
  \leanok
  We have $[UgU][UhU]a=\sum_ig_i(\sum_jh_ja)=\sum_{i,j}g_ih_ja$
  and $[UhU][UgU]a=\sum_jh_j\sum_ig_ia=\sum_{j,i}h_jg_ia$ and these
  sums are equal because $g_ih_j=h_jg_i$.
\end{proof}

\section{The concrete theory}

Note that the abstract theory relies on this finiteness hypothesis that $UgV$
is a finite union of cosets $g_iV$. In our application of this theory our group
$G$ has a topology, and $U$ and $V$ will always be open and compact subgroups.
The following lemma then gives us the hypothesis for free.

\begin{lemma}
  \lean{QuotientGroup.mk_image_finite_of_compact_of_open}
  \label{QuotientGroup.mk_image_finite_of_compact_of_open}
  \discussion{563}
  \leanok
  If $U$ and $V$ are compact subgroups of a topological group~$G$,
  if $V$ is also open, and if $g\in G$, then the double coset space $UgV$
  is a finite union of left cosets $g_iV$.
\end{lemma}
\begin{proof}
  The subset $UgV$ of $G$ is a continuous image of the compact set $U\times V$
  and is hence compact, and it is covered by the disjoint left cosets $g_iV$;
  this cover must thus be finite.
\end{proof}

In the concrete theory, we will need to do various computations with the
specific groups $G$ which we are interested in, and they are restricted products.
So we briefly review that theory first and explain some of the results we'll need.

\subsection{Restricted products}

If $I$ is an index set, if $X_i$ are sets indexed by $i\in I$ and if $Y_i$
are subsets, then the \emph{restricted product} $\prod_i'X_i$ (note the dash) is defined
to be the subset of the full product $\prod_i X_i$ consisting of those
tuples $(x_i)$ such that $x_i\in Y_i$ for all but finitely many~$i$. We suppress
the $Y_i$ from the notation in this document, although in Lean we cannot do this and
the restricted product is written as {\tt Πʳ i, [X i, Y i]}.

It is straightforward to check that if the $X_i$ are groups or rings or $R$-modules,
and the $Y_i$ are subgroups or subrings or submodules, then the restricted product
is a group, ring or $R$-module; indeed the structure is inherited via the
inclusion $\prod'_iX_i\subseteq\prod_iX_i$ (and the fact that arbitrary products
of groups/rings/modules are groups/rings/modules).

More subtle is the theory of topological space structures. If the $X_i$
are topological spaces then we do \emph{not} give $\prod'_iX_i$ the subspace
topology coming from the product topology on $\prod_iX_i$; instead we give
it the finest topology making all of the
natural maps $\prod_{i\in S}X_i\times\prod_{i\notin S}Y_i\to \prod'_iX_i$ continuous,
as $S$ runs through all finite subsets of~$I$; here the product of $X_i$s and $Y_i$s
has the product topology. For example if all of the $Y_i$ are open
then one can check that $\prod_iY_i$ is an open subset of
$\prod'_iX_i$ (this is {\tt RestrictedProduct.isOpen\_forall\_mem} in mathlib),
whereas it is not of the form $\left(\prod'_iX_i\right)\cap U$ for any open subset~$U$
of $\prod_iX_i$ in general; the map from $\prod'_i X_i$ to $\prod_i X_i$ is continuous
but is not in general an embedding.

Here are some basic facts we need about restricted products.

\begin{lemma}
  \lean{Homeomorph.restrictedProductProd}
  \label{Homeomorph.restrictedProductProd}
  \leanok
  \discussion{568}
  If $A_i$ is a family of topological spaces equipped with open
  subsets $B_i$, and if $C_i$ is a family of topological spaces equipped
  with open subsets $D_i$, and if we equip $A_i\times C_i$ with the open
  subset $B_i\times D_i$, then the natural bijection
  $\prod'_i(A_i\times C_i)=\left(\prod'_iA_i\right)\times\left(\prod'_iB_i\right)$
  is a homeomorphism.
\end{lemma}
\begin{remark} This may well not be true if $B_i$ and $D_i$ are not open, because
  filtered colimits and binary products do not appear in general to commute
  in the category of topological spaces. I don't know an explicit counterexample though.
\end{remark}
\begin{proof} We need to check continuity in both directions. The easy way is
  continuity of the map from the restricted product to the map from the binary
  product; the lemma {\tt RestrictedProduct.continuous\_dom} in mathlib
  tells us that a map from a restricted product is continuous when its restriction
  to $\left(\prod_{i\in S}(A_i\times C_i)\right)\times\left(\prod_{i\notin S}(B_i\times D_i)\right)$
  is continuous for all finite $S\subseteq I$; the universal property of the binary
  product tells us that the map into the binary product is continuous iff the maps into
  the factors are continuous, but the map into $\prod'_iX_i$ is a product of the
  natural maps from $\left(\prod_{i\in S}(A_i\times C_i)\right)\times\left(\prod_{i\notin S}(B_i\times D_i)\right)$
  to $\left(\prod_{i\in S}A_i\right)\times\left(\prod_{i\notin S}B_i\right)$
  and the inclusion, and both are known to be continuous (an arbitrary product of continuous
  maps is continuous, and the other claim is in the restricted product API in mathlib).

  The harder direction is the other way, because we are working against both universal
  properties. The trick is {\tt RestrictedProduct.continuous\_dom\_prod} in mathlib
  (this is where we assume $B_i$ and $D_i$ are open), which tells us that a map out of
  a binary product of restricted products is continuous when its restriction to
  $\left(\left(\prod_{i\in S}A_i\right)\times\left(\prod_{i\notin S}B_i\right)\right)\times
  \left(\left(\prod_{i\in S}C_i\right)\times\left(\prod_{i\notin S}D_i\right)\right)$
  is, for all finite $S$ (note that the $S$ in the mathlib lemma is actually our $I-S$).
  The map from this to the restricted product factors through
  $\left(\prod_{i\in S}(A_i\times C_i)\right)\times\left(\prod_{i\notin S}(B_i\times D_i)\right)$;
  the first map is a homeomorphism (use the fact that $\prod_iX_i\times Y_i$ is homeomorphic
  to $\left(\prod_iX_i\right)\times\left(\prod_iY_i\right)$), and the second is continuous
  by definition of the topology on a restricted product.
\end{proof}

\begin{corollary}
  \lean{Homeomorph.restrictedProductPi}
  \label{Homeomorph.restrictedProductPi}
  \leanok
  \discussion{570}
  Restricted products (with respect to open subspaces) commute with finite products.
  In other words, if $j$ runs through a finite set $J$ and $i$ runs through an arbitrary
  set $I$, and if $X_{ji}$ are topological spaces equipped with open subspaces $Y_{ji}$,
  then the obvious bijection $\prod'_i(\prod_j X_{ji})=\prod_j\left(\prod'_i X_{ji}\right)$
  is a homeomorphism.
\end{corollary}
\begin{proof}
  \uses{Homeomorph.restrictedProductProd}
  Induction on the size of the finite set.
\end{proof}

 Let $n$ be a natural and let $M_n(X)$ for a set $X$ denote ``$n\times n$
  matrices with coefficient in $X$'', i.e. $X^{n^2}$. If $X$ is a topological
  spaces then give $M_n(X)$ the product topology.

\begin{corollary}
  If $X_i$ are topological spaces and the $Y_i$ are open subspaces,
  then the obvious map $M_n(\prod'_iX_i)=\prod'_iM_n(X_i)$ is a homeomorphism.
\end{corollary}
\begin{proof}
  \uses{Homeomorph.restrictedProductPi}
  Immediate from the previous corollary.
\end{proof}

We now want to move from matrices to invertible matrices whilst keeping track of topology,
so we need to understand units of topological monoids. Openness of the subobject was
crucial in the above arguments, so we need the next lemma before we can get anywhere.

\begin{lemma} If $M$ is a topological monoid and $U$ is an open submonoid, then
  the units $U^\times$ of $U$ are naturally an open submonoid of $M^\times$.
\end{lemma}
\begin{remark} Note that $M^\times$ doesn't get the subspace topology from~$M$,
  it is embedded into $M\times M$ via $g\mapsto (g,g^{-1})$ and gets the subspace
  topology from the product. This makes it into a topological group.
\end{remark}
\begin{proof}
  We have $U\times U$ is an open subset of $M\times M$, and if we imagine $M^\times$
  embedded in $M\times M$ as explained in the remark above, then the intersection
  of this subgroup with $U\times U$ is open in $M^\times$ and consists of the elements
  of $M^\times$ which are in $U$ and whose inverse is also in $U$, which is easily
  checked to be the copy of $U^\times$ we're talking about.
\end{proof}

Later on, compactness will be key for us, so we record the analogous result
for compactness.

\begin{lemma} If $M$ is a Hausdorff topological monoid and $U$ is a compact submonoid,
  then the units $U^\times$ of $U$ are naturally a compact submonoid of $M^\times$.
\end{lemma}
\begin{remark} Hausdorffness is necessary -- for example the reals with the
  indiscrete topology is a topological monoid under addition, and the diagonal
  in $\R^2$ is not closed with the indiscrete topology.
\end{remark}
\begin{proof}
  First I claim that $M^\times$ embedded in $M\times M$ via $g\mapsto (g,g^{-1})$
  is a closed subset of $M\times M$. Indeed, if $p:M\times M\to M$ is $(a,b)\mapsto ab$
  and $q:M\times M\to M$ is $(a,b)\mapsto ba$, then $p$ and $q$ are continuous,
  $M^\times\subseteq M\times M$ is the intersection
  $p^{-1}\{1\}\cap q^{-1}\{1\}$, and $\{1\}$ is closed because $M$ is Hausdorff.

  We have $U\times U$ is a compact subset of $M\times M$, and so
  $U^\times=M^\times\cap U\times U$ is a closed subspace of a compact space
  and is thus compact.
\end{proof}
