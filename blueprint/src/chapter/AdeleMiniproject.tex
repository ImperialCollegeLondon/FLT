\chapter{Miniproject: Adeles}\label{Adele_miniproject}

\section{Status}

This is an active miniproject.

\section{The goal}

There are several goals to this miniproject.

\begin{enumerate}
  \item Define the adeles $\A_K$ of a number field~$K$ and
    give them the structure of a $K$-algebra (status: now in mathlib thanks to
    Salvatore Mercuri);
  \item Prove that $\A_K$ is a locally compact topological ring (status:
      \href{https://github.com/smmercuri/adele-ring_locally-compact}{
      also proved by Mercuri} but not yet in mathlib);
  \item Base change: show that if $L/K$ is a finite extension of number fields then the
    natural map $L\otimes_K\A_K\to\A_L$ is an isomorphism; (status: not
    formalized yet);
  \item Prove that $K \subseteq \A_K$ is a discrete subgoup and the quotient
    is compact (status: not formalized yet);
  \item Get this stuff into mathlib (status: (1) done, (2)--(4) not done).
\end{enumerate}

We briefly go through the basic definitions. A cheap definition of the finite
adeles $\A_K^\infty$ of $K$ is $K\otimes_{\Z}\Zhat$, where $\Zhat$ is
the profinite completion of the integers. A cheap definition of the infinite adeles
$K_\infty$ of $K$ is $K\otimes_{\Q}\R$, and a cheap definition of the adeles
of $K$ is $\A_K^\infty\times K_\infty$. However in the literature different definitions
are often given. The finite adeles of $K$ are usually defined in the books
as the so-called restricted product $\prod'_{\mathfrak{p}}K_{\mathfrak{p}}$ over the completions
$K_{\mathfrak{p}}$ of $K$ at all maximal ideals $\mathfrak{p}\subseteq\mathcal{O}_K$ of the
integers of $K$. Here the restricted product is the subset of $\prod_{\mathfrak{p}}K_{\mathfrak{p}}$
consisting of elements which are in $\mathcal{O}_{K,\mathfrak{p}}$ for all but finitely many
$\mathfrak{p}$. This is the definition given in mathlib.
Mathlib also has the proof that they're a topological ring;
furthermore the construction of the finite adeles in mathlib works for any
Dedekind domain.

Similarly the infinite adeles of a number field
are usually defined as $\prod_v K_v$,
the product running over the archimedean completions of~$K$, and this is
the mathlib definition.

The adeles of a number field $K$ are the product of the finite and infinite
adeles, and mathlib knows that they're a $K$-algebra and a topological ring.

\section{Local compactness}

As mentioned above, Salvatore Mercuri has a complete formalisation of the proof
that the adele ring is locally compact. His work is in
\href{https://github.com/smmercuri/adele-ring_locally-compact}{his own repo} which
I don't want to have as a dependency of FLT, because this work should all be
in mathlib.

\begin{theorem}
  \lean{NumberField.AdeleRing.locallyCompactSpace}
  \label{NumberField.AdeleRing.locallyCompactSpace}
  \leanok
  The adeles of a number field are locally compact.
\end{theorem}
\begin{proof}
  See Mercuri's repo.
\end{proof}

\section{Base change}

The ``theorem'' we want is that if $L/K$ is a finite extension of number fields,
then $\A_L=L\otimes_K\A_K$. This isn't a theorem though, this is actually a \emph{definition}
(the map between the two objects) and a theorem about
the definition (that it's an isomorphism). Before we can prove the theorem, we need to make the
definition.

Recall that the adeles $\A_K$ of a number field is a product $\A_K^\infty\times K_\infty$
of the finite adeles and the infinite adeles. So our ``theorem'' follows immediately from
the ``theorem''s that $\A_L^\infty=L\otimes_K\A_K^\infty$ and $L_\infty=L\otimes_KK_\infty$.
We may thus treat the finite and infinite results separately.

\subsection{Base change for finite adeles}

Adeles are arithmetic objects, attached to global fields like number fields.
However (as I learnt from Maria Ines de Frutos Fernandez) finite adeles are algebraic
objects, as they can be attached to any Dedekind domain. The definition that we need
is the following.

Let~$A$ be a Dedekind domain with field of fractions~$K$, and write $\mathbb{A}_{A,K}^\infty$
for the finite adeles of $A$. Let~$L/K$ be a finite
separable extension, and let $B$ be the integral closure of~$A$ in~$L$. Recall that
the finite adeles $\mathbb{A}_{A,K}^\infty$ of $K$ with respect to $A$ is the restricted
product of $K_v$

***************************************

\begin{definition}
  \lean{DedekindDomain.FiniteAdeleRing.baseChange}
  \label{DedekindDomain.FiniteAdeleRing.baseChange}
  \leanok
  something **TODO**
\end{definition}

%  Then there's a ``canonical'' isomorphism $\mathbb{A}_{R,K}^\infty \otimes_KL\mathbb{A}_{B,L}^\infty$.

If $A$ is a Dedekind domain then the \emph{height one spectrum} of $A$ is
the nonzero prime ideals of~$A$. Note that because we stick to the literature,
rather than to common sense, fields are Dedekind domains in mathlib, and the
height one spectrum of a field is empty. The reason I don't like allowing fields
to be Dedekind domain is that geometrically the standard definition of Dedekind
domain is ``smooth affine curve, or a point''. But many theorems in algebraic geometry
begin ``let $C$ be a smooth curve''.

There are two steps to the definition of the map; the first is to define it locally
on the individual completions and the second is to glue everything together. Let's
start with the local construction.

Say we're in the AKLB setup above, with $L/K$ a finite separable extension.
Let $w$ be a finite place of $L$ lying above a finite place $v$ of $K$.
We put the $w$-adic topology on $L$ and the $v$-adic topology on~$K$. We now claim
that inclusion $i:K\to L$ is continuous with respect to these topologies. This
claim follows from

\begin{lemma} If $i:K\to L$ denotes the inclusion then $e*w(i(k))=v(k)$, where
  $e$ is the ramification index of $w/v$.
  \label{IsDedekindDomain.HeightOneSpectrum.valuation_comap}
  \lean{IsDedekindDomain.HeightOneSpectrum.valuation_comap}
\end{lemma}
\begin{proof}
  \leanok
  Standard.
\end{proof}

\begin{definition}
  \lean{IsDedekindDomain.HeightOneSpectrum.adicCompletion_comap_algHom}
  \label{IsDedekindDomain.HeightOneSpectrum.adicCompletion_comap_algHom}
  \uses{IsDedekindDomain.HeightOneSpectrum.valuation_comap}
  There's a natural continuous $K$-algebra homomorphism map $K_v\to L_w$. It is defined by completing
  the inclusion $K\to L$ at the finite places $v$ and $w$, which can be done
  by the previous lemma.
\end{definition}

Note: the formalization right now only claims that the map is a $K$-algebra homomorphism,
not the continuity. Do we have continuous $K$-algebra maps?

We can take the product of all of these maps.

\begin{definition}
  \lean{DedekindDomain.ProdAdicCompletions.baseChange}
  \label{DedekindDomain.ProdAdicCompletions.baseChange}
  \uses{IsDedekindDomain.HeightOneSpectrum.adicCompletion_comap_algHom}
  There's a natural $K$-algebra homomorphism $\prod_v K_v\to\prod_w L_w$, where the
  products run over the height one spectrums of $A$ and $B$ respectively.
\end{definition}

One then has to check that for good primes everything works on an integral level,

\begin{definition}
  The map above induces a natural $K$-algebra homomorphism $\A_K^\infty\to\A_L^\infty$
  at the level of finite adeles.
\end{definition}

Note that the finite adeles do not have the subspace topology, so one has to be slightly
careful here.

**********************************************

\section{Discreteness and compactness}

We need that if $K$ is a number field then
$K\subseteq\mathbb{A}_K$ is discrete, and the quotient (with the
quotient topology) is compact. Here is a proposed proof.

\begin{theorem}
  \lean{Rat.AdeleRing.zero_discrete}
  \label{Rat.AdeleRing.zero_discrete}
  \leanok
  There's an open subset of $\A_{\Q}$ whose intersection with $\Q$ is $\{0\}$.
\end{theorem}
\begin{proof}
  Use $\prod_p{\Z_p}\otimes(-1,1)$. Any rational $q$ in this set is a $p$-adic
  integer for all primes $p$ and hence (writing it in lowest terms as $q=n/d$)
  satisfies $p\nmid d$, meaning that $d=\pm1$ and thus $q\in\Z$. The fact
  that $q\in(-1,1)$ implies $q=0$.
\end{proof}

\begin{theorem}
  \lean{Rat.AdeleRing.discrete}
  \label{Rat.AdeleRing.discrete}
  \leanok
  The rationals $\Q$ are a discrete subgroup of $\A_{\Q}$.
\end{theorem}
\begin{proof}
  If $q\in\Q$ and $U$ is the open subset in the previous lemma, then
  it's easily checked that $\Q\cap U=\{0\}$ implies $\Q\cap (U+q)=\{q\}$,
  and $U+q$ is open.
\end{proof}

\begin{theorem}
  \lean{NumberField.AdeleRing.discrete}
  \label{NumberField.AdeleRing.discrete}
  \leanok
  The additive subgroup $K$ of $\A_K$ is discrete.
\end{theorem}
\begin{proof}
  By a previous result, we have $\A_K=K\otimes_{\Q}\A_{\Q}$.
  Choose a basis of $K/\Q$; then $K$ can be identified with $\Q^n\subseteq(\A_{\Q})^n$
  and the result follows from the previous theorem.
\end{proof}

For compactness we follow the same approach.

\begin{theorem}
  \lean{Rat.AdeleRing.cocompact}
  \label{Rat.AdeleRing.cocompact}
  \leanok
  The quotient $\A_{\Q}/\Q$ is compact.
\end{theorem}
\begin{proof}
  The space $\prod_p\Z_p\times[0,1]\subseteq\A_{\Q}$ is a product of compact spaces
  and is hence compact. I claim that it surjects onto $\A_{\Q}/\Q$. Indeed,
  if $a\in\A_{\Q}$ then for the finitely many prime numbers $p\in S$ such that $a_p\not\in\Z_p$
  we have $a_p\in\frac{r_p}{p^{n_p}}+\Z_p$ with $r_p/p^{n_p}\in\Q$, and
  if $q=\sum_{p\in S}\frac{r_p}{p^{n_p}}\in\Q$ then $a-q\in \prod_p\Z_p\times\R$.
  Now just subtract $\lfloor a_{\infty}-q\rfloor$ to move into $\prod_p\Z_p\times[0,1)$
  and we are done.
\end{proof}

\begin{theorem}
  \lean{NumberField.AdeleRing.cocompact}
  \label{NumberField.AdeleRing.cocompact}
  \leanok
  The quotient $\A_K/K$ is compact.
\end{theorem}
\begin{proof}
  We proceed as in the discreteness proof above, by reducing to $\Q$. As before, choosing
  a $\Q$-basis of $K$ gives us $\A_K/K\cong(\A_{\Q}/\Q)^n$ so the result follows from
  the previous theorem.
\end{proof}
