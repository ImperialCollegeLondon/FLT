\chapter{Miniproject: Quaternion algebras}\label{Quat_alg_project}

\section{The goal}

At the time of writing, {\tt mathlib} still does not have a proof that the space
of classical modular forms of a fixed weight, level and character is finite-dimensional.
The main result in this miniproject is to prove that certain spaces of quaternionic modular forms
of a fixed weight, level and character are finite-dimensional. We need finiteness results
like this in order to control the Hecke algebras which act on these spaces; these Hecke
algebras are the ``$T$''s which are isomorphic to the ``$R$''s in the $R=T$ theorem which
is the big first target for the FLT project.

\section{Initial definitions}

Our first goal in this miniproject is the definition of these spaces of quaternionic modular forms.
We start with some preliminary work towards this.

Let $K$ be a field. Recall that a \emph{quaternion algebra}
over $K$ is a central simple $K$-algebra of $K$-dimension~4.

A fundamental fact about central simple algebras is that if $D/K$
is a central simple $K$-algebra and $L/K$ is an extension of fields, then $D\otimes_KL$
is a central simple $L$-algebra. In particular if $D$ is a quaternion algebra over $K$
then $D\otimes_KL$ is a quaternion algebra over $L$. Some Imperial students have established
this fact in ongoing project work.

A \emph{totally real field} is a number field~$F$ such that the image of every ring
homomorphism $F\to\bbC$ is a subset of $\R$. We fix once and for all a totally real field~$F$ and a
quaternion algebra $D$ over $F$. We furthermore assume that $D$ is \emph{totally definite}, that is,
that for all field embeddings $\tau:F\to\R$ we have $D\otimes_{F,\tau}\R\cong\bbH$. Because $F$
has at least one real place, the totally definiteness hypothesis is enough to show that $D$
is not a matrix algebra and thus must be a division algebra. Thus Fujisaki's theorem {\bf TODO link}
from the Fujisaki miniproject applies, and we know that $D^\times\backslash (D\otimes_F\A_F)^{(1)}$
is compact. We fix once and for all a maximal compact subgroup $K_\infty$ of
$(D\otimes_{\Q}\R)^\times$; all maximal compact subgroups are conjugate so changing this choice
just amounts to some
bookkeeping. Because $D\otimes_{\Q}\R$ is isomorphic to $\prod_{v\mid\infty}\bbH$, the maximal
compact subgroup is isomorphic to $\prod_{v\mid\infty}S^3$, where $S^3$ denotes the unit
quaternions in $\bbH$.

The high-falutin' explanation of what is about to happen is that the units $D^\times$ of $D$
can be regarded as a connected reductive algebraic group over $F$, and we are going to define spaces
of automorphic forms for this algebraic group. For a general connected reductive algebraic group,
part of the definition of an automorphic form is that it is satisfies some differential
equations (for example modular forms are automorphic forms for the algebraic group $\GL_2$ over
$\Q$, and the definition of a modular form involves holomorphic functions, which are solutions to
the Cauchy--Riemann equations). However under the assumption that $F$ is totally real and $D/F$ is
totally definite, the ``associated symmetric space is 0-dimensional'', meaning in practice that
no differential equations are involved in the definition of an automorphic form in this setting.
As a consequence, the definitions we're about to give have a far more algebaic flavour and, as
we shall see, it is possible to construct mod $p$ and $p$-adic variants of these spaces without
too much trouble.

\section{Brief introduction to automorphic forms in this setting}

Having made assumptions on $D$ which makes the theory of automorphic forms over $D^\times$
far less technical, we will now make it a little more technical by using the modern adelic
approach to the theory. Note that many results about the adeles of a number field are proved
in the adele miniproject \ref{Adele_miniproject}. Our automorphic forms will be certain
functions on the units of the ring $D_{\A}:=D\otimes_F\A_F\cong D\otimes_{\Q}\A_{\Q}$
and there are adelic analogues of a weight, level and character in this setting, corresponding
to the classical notions which one sees in the theory of modular forms. We remark again that
there is no analogue of the holomorphicity condition that one sees in the classical theory,
because the symmetric space is a finite set of points rather than the upper half plane. Also
there is no analogue of the cuspidality condition because there are no cusps in this setting.
We will fix a weight $\rho_\infty$, a level $U$ and a character $\chi$, and define
a complex vector space $S_{\rho_\infty}^D(U;\chi)$ of quaternionic modular forms of level $U$,
weight $\rho_\infty$ and character $\chi$. The main theorem of this miniproject is the claim
that this space is finite-dimensional.

\section{Definition of spaces of automorphic forms}

Let us now give precise definitions of weights, levels, characters, and these spaces of quaternionic
modular forms.

A \emph{weight} $\rho_\infty$ is a finite-dimensional $\bbC$-vector space $W$ (with the
usual vector space topology) equipped with a continuous action of $K_\infty$, our fixed maximal
compact subgroup. For applications
to Fermat's Last Theorem we only need to consider the case where $W=\bbC$ and $\rho_\infty$
is the trivial representation, but there is no harm in setting things up in more generality.
The case $W=\bbC$ corresponds (via the highly non-trivial Jacquet-Langlands correspondence)
when $F=\Q$ to the case of modular forms of weight 2, and for general~$F$ corresponds to
Hilbert modular forms of parallel weight~2.

A \emph{level} is a compact open subgroup~$U$ of $(D\otimes_F\A_F^\infty)^\times$. These are
plentiful. The ring $D_f:=D\otimes_F\A_F^\infty$ is a topological ring, and this fact is currently
in the process of being PRed to mathlib. Hence the units $D_f^\times$ of this ring
are a topological group. This group is locally profinite, and hence has many compact open subgroups;
we will see explicit examples later on.

A \emph{character} is a continuous group homomorphism $\chi$ from $F^\times\backslash\A_F^\times$ to
$\bbC^\times$. For many of the applications, $\chi$ can also be trivial, although we will crucially
have to allow certain nontrivial characters of $p$-power order when we are doing the patching
argument needed to prove the modularity lifting theorem which is the big first target of the FLT
project. We regard $\A_F$ as a subring of $D_{\A}:=D\otimes_F\A_F$, which is possible because
$F$ is a subring of $D$. More precisely we embed $\A_F$ into $D\otimes_F\A_F$
via the map sending $g$ to $1\otimes g$. Because $F$ is in the centre of~$D$, we have
that $\A_F$ is in the centre of $D_{\A}$ and thus $F^\times\backslash\A_F^\times$
is a central subgroup of $D_{\A}^\times$.

We fix a weight $(W,\rho_{\infty})$, a level $U$ and a character $\chi$.

\begin{definition}
  \lean{TotallyDefiniteQuaternionAlgebra.AutomorphicForm}
  \label{TotallyDefiniteQuaternionAlgebra.AutomorphicForm}
  \leanok
  An $R$-valued \emph{automorphic form} of weight $W$, level $U$ and character $\chi$ for $D$ is
  a function $f:D^\times\backslash D_{\A}^\times\to W$ satisfying the following axioms:
  \begin{itemize}
    \item $f(gk_\infty)=\rho(k_\infty)f(g)$ for all $k\in K_\infty$ and $g\in D_{\A}^\times$.
    \item $f(gz)=\chi(z)f(g)$ for all $g\in D_{\A}^\times$ and $z\in\A_F^\times$ (this makes
    sense because $W$ is a $\bbC$-vector space).
    \item $f(gu)=f(g)$ for all $g\in D_{\A}^\times$ and $u\in U$.
  \end{itemize}
\end{definition}

Let $S_{\rho_\infty}^D(U;\chi)$ denote the space of automorphic forms of weight $W$, level $U$
and character $\chi$. Two basic observations are

\begin{definition}
  \lean{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.addCommGroup}
  \label{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.addCommGroup}
  \uses{TotallyDefiniteQuaternionAlgebra.AutomorphicForm}
  \leanok
  Pointwise addition $(f_1+f_2)(g):=f_1(g)+f_2(g)$ makes $S_{\rho_\infty}^D(U;\chi)$ into an
  additive abelian group.
\end{definition}

\begin{definition}
  \lean{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.module}
  \label{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.module}
  \uses{TotallyDefiniteQuaternionAlgebra.AutomorphicForm,
    TotallyDefiniteQuaternionAlgebra.AutomorphicForm.addCommGroup}
  \leanok
  Pointwise scalar multiplication $(r\cdot f)(g):= r\cdot(f(g))$ makes
  $S_{\rho_\infty}^D(U;\chi)$ into an $R$-module.
\end{definition}

These spaces $S_{\rho_\infty}^D(U;\chi)$ are sometimes referred to as spaces of
``quaternionic modular forms''. The Hecke algebras involved in the main modularity lifting
theorems needed in the FLT project will be endomorphisms of these spaces.

\section{Statement of the main result of the miniproject}

The point of this miniproject is the following goal:

\begin{theorem}
  \lean{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.finiteDimensional}
  \label{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.finiteDimensional}
  \uses{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.module}
  The space $S_{\rho_\infty}^D(U;\chi)$ is a finite-dimensional $k$-vector space.
\end{theorem}

This is an analogue of the result that classical modular forms of a fixed
level, weight and character are finite-dimensional. In fact, by delicate results
of Jacquet and Langlands this result (in the case $k=\bbC$) implies many cases of that classical claim,
although of course the Jacquet--Langlands theorem is much much harder to prove than the classical
proof of finite-dimensionality.

The finite-dimensionality theorem is in fact an easy consequence of Fujisaki's lemma,
proved in the Fukisaki miniproject, chapter~\ref{Fujisaki_project}. {\bf TODO add the
consequence}

\begin{proof}
  \proves{TotallyDefiniteQuaternionAlgebra.AutomorphicForm.finiteDimensional}
  \uses{DivisionAlgebra.finiteDoubleCoset}
  Choose a set of coset representative $g_1,g_2,\ldots,g_n$ for
  $D^\times\backslash(D\otimes_F\A_F^\infty)^\times/U$. My claim is that
  the function $S_{W,\chi}(U;k)\to W^n$ sending $f$ to $(f(g_1),f(g_2),\ldots,f(g_n))$
  is injective and $k$-linear, which suffices by finite-dimensionality of $W$.
  $k$-linearity is easy, so let's talk about injectivity.

  Say $f_1$ and $f_2$ are two elements of $S_{W,\chi}(U;k)$ which agree on
  each $g_i$. It suffices to prove that $f_1(g)=f_2(g)$ for all
  $g\in(D\otimes_F\A_F^\infty)^\times$. So say $g\in(D\otimes_F\A_F^\infty)^\times$,
  and write $g=\delta g_iu$ for $\delta \in D^\times$ and $u\in U$.
  Then $f_1(g)=f_1(\delta g_iu)=\delta\cdot f_1(g_i)$ (by hypotheses (i) and (iii)
  of the definition of $S_{W,\chi}(U;k)$), and similarly $f_2(g)=\delta\cdot f_2(g_i)$
  and because $f_1(g_i)=f_2(g_i)$ by assumption, we deduce $f_1(g)=f_2(g)$ as required.
\end{proof}

  \label{FiniteAdeleRing.DivisionAlgebra.finite_doset_of_compact_quotient}
  Compactness of the above quotient $B^\times\backslash B_{\A}^{(1)}$ implies Fujisaki's lemma.
\end{lemma}
\begin{proof}
  There's a natural map $\alpha$ from $B^\times\backslash B_{\A}^{(1)}$ to
  $B^\times\backslash (B\otimes_K \A_K^\infty)^\times$. We claim that it's
  surjective. Granted this claim, we are home, because if we put the quotient
  topology on $B^\times\backslash (B\otimes_K \A_K^\infty)^\times$ coming from
  $(B\otimes_K \A_K^\infty)^\times$ then it's readily verified that $\alpha$
  is continuous, and that the double coset decomposition
  $(B\otimes_K \A_K^\infty)^\times=\coprod_i B^\times g_i U$ descends to a
  cover of $B^\times\backslash (B\otimes_K \A_K^\infty)^\times$ by disjoint opens,
  which must then be finite by compactness.

  As for surjectivity: say $x\in (B\otimes_K \A_K^\infty)^\times$. We need to extend
  $x$ to an element $(x,y)\in (B\otimes_K \A_K^\infty)^\times\times(B\otimes_K K_\infty)^\times$
  which is in the kernel of $\delta_{B_{\A}}$. Because $\delta_{B_{\A}}(x,1)$ is some positive
  real number, it will suffice to show that if $r$ is any positive real number then we can
  find $y\in (B\otimes_K \A_K^\infty)^\times=(B\otimes_{\Q}\R)^\times$ with $\delta_{B_{\A}}(1,y)=r$,
  or equivalently (setting $B_{\R}=B\otimes_{\Q}\R$) that $\delta_{B_{\R}}(y)=r$.
  But $B\not=0$ as it is a division algebra,and hence $\Q\subseteq B$, meaning
  $\R\subseteq B_{\R}$, and if
  $x\in\R^\times\subseteq B_{\R}^\times$ then $\delta(x)=|x|^d$ with $d=\dim_{\Q}(B)$,
  as multiplication by $x$ is just scaling by a factor of $x$ on $B_{\R}\cong\R^d$.
  In particular we can set $x=y^{1/d}$.
\end{proof}

Why am I writing this proof backwards? {\bf TODO} rewrite it all forwards.

It thus suffices to show that if $B$ is a finite-dimensional division algebra
(with centre $K$ -- do we use this? Presumably not) over a number field $K$
then the quotient $B^\times\backslash B_{\A}^{(1)}$ is compact. Recall that
$B_{\A}=B\otimes_{\Q}\R$, and $B_{\A}^{(1)}$ is the elements of $B_{\A}^\times$
such that multiplication by them doesn't change Haar measure (that is, the
kernel of the Haar character), and we have already seen that $B^\times$ is a subgroup
of this.

Our proof comes in several parts.


\begin{lemma}
  \label{E}
  There's a compact subset $E$ of $B_{\A}$
  with the property that for all $x\in B_{\A}^{(1)}$,
  the obvious map $xE\to B\backslash B_{\A}$ is not injective.
\end{lemma}

\begin{proof} We know that $B\backslash B_{\A}=(\Q\backslash\A_{\Q})^N$
  is compact, and that $B$ is discrete in $B_{\A}$.
    Fix a Haar measure $\mu$ on $B_{\A}$ and push it forward
    to $B\backslash B_{\A}$; this quotient has finite
    and positive measure, say $m\in\R_{>0}$.
    Choose any compact $E\subseteq B_{\A}$ with measure $> m$
    (for example, choose a $\Z$-lattice $L\cong\Z^d$ in $B\cong\Q^d$,
    define $E_f:=\prod_p L_p\in B\otimes_{\Q}\A_{\Q}^\infty$,
    and define $E_{\infty}\subseteq B\otimes_{\Q}\R\cong\R^n$ to be a huge closed
    ball, large enough to ensure the measure of $E:=E_f\times E_{\infty}$ is bigger than $m$).
    Then $\mu(xE)=\mu(E)>m$ so the map can't be injective.
\end{proof}

Define $X:=E-E=\{e-f:e,f\in E\}$ and $Y:=X*X=\{x*y:x,y\in X\}$.
  Then $X$ and $Y$ are
  also compact subsets of $B_{\A}$ as they're continuous images
  of compact sets.

  \begin{lemma}
    \label{X_meets_kernel}
    If $\beta\in B_{\A}^{(1)}$ then
  $\beta X\cap B^\times\not=\emptyset$.
  \end{lemma}
  \begin{proof}
  Indeed by the previous lemma, the map $\beta E\to B\backslash B_{\A}$
  isn't injective, so there are distinct
  $\beta e_1,\beta e_2\in \beta E$ with
  $\beta e_1-\beta e_2=b\in B$.
  Now $b\not=0$ and $B$ is a division algebra, so $b\in B^\times$.
  And $e_1-e_2\in X$ so $b=\beta(e_1-e_2)\in \beta X$, so we're done.
\end{proof}

\begin{lemma}
  \label{X_meets_kernel'}
  Similarly, if $\beta\in B_{\A}^{(1)}$ then I claim
  $X\beta^{-1}\cap B^\times\not=\emptyset$.
\end{lemma}
\begin{proof}
  Indeed, $\beta^{-1}\in B_{\A}^{(1)}$, and so left multiplication by $\beta^{-1}$
  doesn't change Haar measure on $B_{\A}$, so neither does right multiplication
  (as they change Haar measure by the same amount, as $B$ is a form of a matrix
  algebra: did I remember to prove this? {\bf TODO}).
  So the same argument works: $E\beta^{-1}\to B\backslash B_{\A}$ is not
  injective so choose $e_1\beta^{-1}\not=e_2\beta^{-1}$ with difference $b\in B$
  and then $(e_1-e_2)\beta^{-1}\in B^\times$.
\end{proof}

\begin{lemma}
  \label{Y_meet_units_B}
  $Y\cap B^\times$ is finite.
\end{lemma}
\begin{proof} It suffices to prove that $Y\cap B$ is finite.
    But $B\subseteq B_{\A}$ is a discrete additive subgroup, and hence closed.
    And $Y\subseteq B_{\A}$ is compact.
    So $B\cap Y$ is compact and discrete, so finite.
\end{proof}

Now let $T=Y\cap B^\times$ be this finite subset
of $B_{\A}$, and define $K:= (T^{-1}*X) \times X\subset B_{\A}\times B_{\A}$,
noting that $K$ is compact because $X$ is compact and $T$ is finite.

\begin{lemma} For every $\beta\in B_{\A}^{(1)}$, there exists $b\in B^\times$
  and $\nu\in B_{\A}^{(1)}$ such that $\beta=b\nu$ and $(\nu,\nu^{-1})\in K.$
\end{lemma}

  Before we prove this, let's show that it implies what we want,
  namely that $B^\times\backslash B_{\A}^{(1)}$
  is compact.

  Indeed, if $M$ is the preimage of $K$ under the map $B_{\A}^{(1)} \to B_{\A}\times B_{\A}$
  sending $\nu$ to $(\nu,\nu^{-1})$, then $M$ is a closed subspace (assuming $\delta_{B_{\A}}$
  is continuous!) of a compact
  space so it's compact, and step 6 shows that $M$ surjects onto
  $B^\times\backslash B_{\A}^{(1)}$ which is thus also compact.


  It suffices then to show that for every $\beta\in B_{\A}^{(1)}$, there exists
  $b\in B^\times$ and $\nu\in B_{\A}^{(1)}$ such that $\beta=b\nu$ and
  $(\nu,\nu^{-1})\in K.$
\begin{proof}

  By an earlier lemma, $\beta X\cap B^\times\not=\emptyset$, and by another earlier lemma,
  $X\beta^{-1}\cap B^\times\not=\emptyset$, so we can write $\beta x_1=b_1$
  and $x_2\beta^{-1}=b_2$ with obvious notation.

  Multiplying, $x_2x_1=b_2b_1\in Y\cap B^\times=T$ (recall that $Y=X*X$ and $T=Y\cap B^\times$
  is finite); call this element $t$.
  Note that $T\subset B^\times$ so $t$ is a unit, and thus $x_1,x_2$ are units
  (a left or right divisor of a unit is a unit; this is a general fact about subrings of matrix
  rings and may be true more generally).

  Then $x_1^{-1}=t^{-1}x_2\in T^{-1}*X$, and $x_1\in X$, so if we set $\nu=x_1^{-1}$
  and $b=b_1$ then we have $\beta=b\nu$ and $(\nu,\nu^{-1})\in K := (T^{-1}*X)\times X$.
  We are done!
\end{proof}
